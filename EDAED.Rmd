---
title: "Estadística descriptiva y análisis exploratorio de datos"
author: "Sebastian Gaviria Sánchez"
date: '2022-09-19'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, results = T, message = F)
library(tidyverse)
library(plotly)
```

```{r}
library(readxl)
data <- read_excel("datosModelo2.xlsx", col_types = c("text", 
    "text", "text", "numeric", "text", "numeric", 
    "date", "date", "date", "text", "text", 
    "text", "numeric", "text", "text", "text", 
    "text", "text", "text", "text", "text", 
    "text", "text", "text", "text", "numeric", 
    "text", "text", "text", "numeric"))

```

```{r}
data <- data %>%
  mutate(TALLER = as.factor(TALLER),
         DESCRIPCION_PARTE = as.factor(DESCRIPCION_PARTE),
         CANTIDAD_REF = as.factor(CANTIDAD_REF),
         VERSION = as.factor(VERSION),
         TIPO_DE_SERVICIO = as.factor(TIPO_DE_SERVICIO),
         EMPRESA = as.factor(EMPRESA),
         TIPO = as.factor(TIPO),
         DESCRIPCION_SERVICIO = as.factor(DESCRIPCION_SERVICIO),
         DESCRIPCION_INGRESO = as.factor(DESCRIPCION_INGRESO),
         ESTADO = as.factor(ESTADO),
         TIPO_REPUESTO = as.factor(TIPO_REPUESTO),
         DEPARTAMENTO = as.factor(DEPARTAMENTO),
         CIUDAD = as.factor(CIUDAD),
         MODELO_AÑO = as.factor(MODELO_AÑO),
         CIUDAD_PROPIETARIO = as.factor(CIUDAD_PROPIETARIO),
         DEPARTAMENTO_PROPIETARIO = as.factor(DEPARTAMENTO_PROPIETARIO),
         RENTING = as.factor(RENTING))
```

Es de interés conocer cómo se comportan las empresas que más registros de fallas poseen en los fallos más comunes de los camiones STARK E-CARGO 4T y que requieren un recambio del componente. Para dicha causa se seleccionan las seis empresas con más vehículos ingresados a taller y adicionalmente se eligen los 13 fallos más comunes en dichas empresas. La información se ilustra así: 

```{r out.height=500, out.width=900}
empresas <- names(sort(table(data$EMPRESA),T)[1:6])
p1 <- data %>% 
  filter(EMPRESA %in% empresas,
         DESCRIPCION_PARTE == "BATERIAS 12V" |
         DESCRIPCION_PARTE == "VCU SOFTWARE C (230)" |
         DESCRIPCION_PARTE == "SENSOR DE PRESION" |
         DESCRIPCION_PARTE == "CARGADOR PORTABLE 15KW" |
         DESCRIPCION_PARTE == "BUJE AMORTIGUADOR CON CAUCHO" |
         DESCRIPCION_PARTE == "TERMINAL INTELIGENTE DE VEHICULO" |
         DESCRIPCION_PARTE == "ORING" |
         DESCRIPCION_PARTE == "FLASHER" |
         DESCRIPCION_PARTE == "RELOJ RESORTE DE TIMON" |
         DESCRIPCION_PARTE == "AMORTIGUADOR (DELANTERO)" |
         DESCRIPCION_PARTE == "SISTEMA DE REFRIGERACIÓN MOTOR" |
         DESCRIPCION_PARTE == "CONECTOR SENSOR DE PRESION" | 
         DESCRIPCION_PARTE == "COMPRESOR AIRE DE FRENOS (230VH)") %>%
  ggplot(., aes(x = DESCRIPCION_PARTE, 
                fill = DESCRIPCION_PARTE)) +
  geom_bar() +
  facet_wrap(~EMPRESA) +
  labs(title = "Fallas más comunes por empresa", y = "Cantidad",
       x = "", fill = "Parte") +
  theme(axis.text.x = element_blank())
ggplotly(p1)
```


- Las seis empresas que más ingresos registran son en orden descendente BIMBO con 342 ingresos a taller, seguida por ARGOS con 283 ingresos, NUTRESA con 166, ÉXITO con 142 camiones ingresados a taller, BAVARIA con 142 y por último OPERLOG con 111 registros.

- Sin embargo, como se puede apreciar en este gráfico, la empresa que tiene los vehículos que más fallan y requieren repuestos es ARGOS. Específicamente se puede notar que los bujes de la suspensión son los más afectados en estos vehículo y podría pensarse que esta situación se da gracias a las condiciones de trabajo en esta empresa (cargas más pesadas o rutas más exigentes).

- La situación cambia cuando nos referimos a BIMBO, segunda empresa que solicita más repuestos. Allí las fallas de los camiones se encuentran más relacionadas con componentes electrónicos del mismo. La terminal inteligente, sensores de presión y el reloj resorte de timón son las fallas más comunes.

- Una situación diferente se vive con los camiones del ÉXITO. Siendo esta la tercera empresa con más fallas en sus vehículos, dichas fallas se concentran en componentes como las baterías de 12v y el cargador portable. Una posible explicación a esto puede ser que los operarios tienen un trato rudo con el cargador en cuestión debilitando cables o demás componentes del mismo. 

- Los vehículos de NUTRESA tienen una situación similar a la de los camiones de ARGOS. Los fallos más comunes son en bujes de suspensión y en el reloj resorte de timón. Podría aseverarse que las causas son por las mismas condiciones de trabajo que en ARGOS.

- Finalmente, BAVARIA y OPERLOG son dos empresas que en términos de sus camiones, las fallas se concentran en los mismos conceptos. Sistema de refrigeración del motor, la terminal inteligente del vehículo y el VCU son los componentes que más fallan y se cambian en estas empresas. 


De manera similar es interesante observar si las condiciones de cada departamento influyen en la manera como fallan los camiones en cuestión y en la dinamica de solicitud de respuestos en cada uno de los mismos. Para este caso se plantea el siguiente gráfico con los departamentos de ANTIOQUIA, CUNDINAMARCA, RISARALDA y VALLE DEL CAUCA en los mismos conceptos de fallo anteriores. 

```{r out.height=500, out.width=900}
p2 <- data %>% 
  filter(DESCRIPCION_PARTE == "BATERIAS 12V" |
         DESCRIPCION_PARTE == "VCU SOFTWARE C (230)" |
         DESCRIPCION_PARTE == "SENSOR DE PRESION" |
         DESCRIPCION_PARTE == "CARGADOR PORTABLE 15KW" |
         DESCRIPCION_PARTE == "BUJE AMORTIGUADOR CON CAUCHO" |
         DESCRIPCION_PARTE == "TERMINAL INTELIGENTE DE VEHICULO" |
         DESCRIPCION_PARTE == "ORING" |
         DESCRIPCION_PARTE == "FLASHER" |
         DESCRIPCION_PARTE == "RELOJ RESORTE DE TIMON" |
         DESCRIPCION_PARTE == "AMORTIGUADOR (DELANTERO)" |
         DESCRIPCION_PARTE == "SISTEMA DE REFRIGERACIÓN MOTOR" |
         DESCRIPCION_PARTE == "CONECTOR SENSOR DE PRESION" | 
         DESCRIPCION_PARTE == "COMPRESOR AIRE DE FRENOS (230VH)") %>%
  ggplot(., aes(x = DESCRIPCION_PARTE, 
                fill = DESCRIPCION_PARTE)) +
  geom_bar() +
  facet_wrap(~DEPARTAMENTO) +
  labs(title = "Fallas más comunes por departamento", y = "Cantidad",
       x = "", fill = "Parte") +
  theme(axis.text.x = element_blank())
ggplotly(p2)
```


- Lo primero que se debe notar acá es que el departamento de ANTIOQUIA es el que más fallas registra en casi todos los conceptos, esto a pesar de que posee casi el mismo número de vehículos ingresados a taller que CUNDINAMARCA. Esta situación puede deberse a que en ANTIOQUIA es más común que los vehículos ingresen a taller por un fallo puntual y requiera recambio que por mantenimiento, caso contrario que en el departamento de CUNDINAMARCA.

- Puntualmente hablando, en ANTIOQUIA es menos usual que los vehículos fallen por ORING, puesto que no se tienen registros de este fallo particular en el departamento.

- De manera similar, en ANTIOQUIA se registran menos fallos relacionados al sistema de refrigeración del motor. Una posible causa potencial para esta situación es que gracias a los atascos de la ciudad de BOGOTÁ, el radiador que enfría el líquido refrigerante del sistema recibe menos viento. Esto en contraste con MEDELLÍN, donde es un poco menos usual y en menor intensidad los trancones. 

- Gracias al tamaño del parque automor en los departamentos de RISARALDA y VALLE DEL CAUCA, se tienen menos registros de fallos relacionados a estos conceptos más frecuentes. Particularmente en RISARALDA se tienen dos averías donde se cambió la VCU. En el VALLE DEL CAUCA la falla más usual donde se requiere recambio es por los bujes de suspensión.


Por otro lado, es de interés también observar el comportamiento de solicitud de repuestos a lo largo de los meses y los años. Esto para visualizar posibles tendencias en el comportamiento de este fenómeno. Se plantea así el siguiente gráfico:

```{r out.height=500, out.width=900}
library(lubridate)
p3 <- data %>%
  mutate(MES = month(FECHA_INGRESO, T),
         ANIO = year(FECHA_INGRESO)) %>%
  filter(DESCRIPCION_SERVICIO == "CORRECTIVO") %>%
  ggplot(aes(x = MES)) + 
  geom_bar(fill = "darkorange") +
  labs(title = "Cantidad de repuestos por mes y año", y = "Cantidad", x = "Mes") +
  facet_wrap(~ANIO)
ggplotly(p3)
```

En este gráfico se aprecia inicialmente un periodo de 4 años desde el 2019 hasta la fecha actual. En el año 2019 se tiene una cantidad mínima de repuestos cambiados. Sin embargo desde el 2020 y hasta el día de hoy, la solicitud de recambios en los camiones STARK no ha parado de crecer. Esto último responde naturalmente al crecimiento del parque automotor de este modelo a lo largo del periodo de tiempo en cuestión.

Ahora, analizando lo discutido anteriormente respecto a los departamentos de cara al kilometraje, se propone la siguiente figura:

```{r out.height=500, out.width=900}
p4 <- data %>%
  #select(KILOMETRAJE, DESCRIPCION_PARTE, DEPARTAMENTO) %>%
  filter(DESCRIPCION_PARTE == "BATERIAS 12V" |
         DESCRIPCION_PARTE == "VCU SOFTWARE C (230)" |
         DESCRIPCION_PARTE == "SENSOR DE PRESION" |
         DESCRIPCION_PARTE == "CARGADOR PORTABLE 15KW" |
         DESCRIPCION_PARTE == "BUJE AMORTIGUADOR CON CAUCHO" |
         DESCRIPCION_PARTE == "TERMINAL INTELIGENTE DE VEHICULO") %>%
  ggplot(., aes(x = DESCRIPCION_PARTE, y = KILOMETRAJE, 
                fill = DESCRIPCION_PARTE)) +
  geom_boxplot() +
  stat_summary(fun=mean, geom="point", shape=13, size=2, color="blue") +
  facet_wrap(~DEPARTAMENTO) +
  labs(title = "Kilometraje a los fallos mas comunes por departamento",
       x = "", y = "Kilometraje", fill = "Parte") +
  theme(axis.text.x = element_blank())
ggplotly(p4)
```


- En este gráfico se ilustran los seis fallos con recambio más comunes en cada departamento con relación al kilometraje registrado en el momento del ingreso a taller. 

- Como se mencionó anteriormente, ANTIOQUIA es el departamento que posee un mayor registro de recambios, por lo cuál se puede apreciar un comportamiento acorde en este gráfico con lo detallado anteriormente. Sin embargo, en este caso se puede notar que el fallo más temprano es con relación a los cargadores portables, que en promedio se cambian por debajo de los 10.000 kilómetros. Esto indica que si una unidad cargadora portátil va a fallar, probablemente lo hará en los primeros 10.000 kilómetros de uso. Esta situación también es plausible en CUNDINAMARCA.

- De igual forma, se consignó además que en ANTIOQUIA la falla con recambio más común se presenta a causa de los bujes de amortiguador. En este caso se puede notar que esta falla generalmente se produce entre los 30.000 y los 45.000 kilómetros. Este promedio es significativamente mayor al de los demás departamentos puesto que dicha falla en CUNDINAMARCA sucede principalmente entre los 10.000 y los 20.000 kilómetros. Una causa razonable para esta situación podría ser el estado de las vías. 

- Otro contraste significativo en este gráfico puede verse en relación al sensor de presión, donde en ANTIOQUIA suele durar un poco más antes de necesitar ser cambiado respecto al departamento de CUNDINAMARCA, donde generalmente falla antes de los 15.000 kilómetros. 


De manera similar, para examinar la relación entre el kilometraje y el concepto de falla y reemplazo, ahora discriminando en las 6 empresas con más registros, se tiene el siguiente gráfico: 

```{r out.height=500, out.width=900}
p5 <- data %>% 
 # select_(KILOMETRAJE, DESCRIPCION_PARTE, EMPRESA) %>%
  filter(EMPRESA %in% empresas,
         DESCRIPCION_PARTE == "BATERIAS 12V" |
         DESCRIPCION_PARTE == "VCU SOFTWARE C (230)" |
         DESCRIPCION_PARTE == "SENSOR DE PRESION" |
         DESCRIPCION_PARTE == "CARGADOR PORTABLE 15KW" |
         DESCRIPCION_PARTE == "BUJE AMORTIGUADOR CON CAUCHO" |
         DESCRIPCION_PARTE == "TERMINAL INTELIGENTE DE VEHICULO") %>%
  ggplot(., aes(x = DESCRIPCION_PARTE, y = KILOMETRAJE, 
                fill = DESCRIPCION_PARTE)) +
  geom_boxplot() +
  stat_summary(fun=mean, geom="point", shape=13, size=2, color="blue") +
  facet_wrap(~EMPRESA) +
  labs(title = "Kilometraje a los fallos mas comunes por empresa",
       x = "", y = "Kilometraje", fill = "Parte") +
  theme(axis.text.x = element_blank())
ggplotly(p5)
```


- Teniendo en cuenta que la empresa ARGOS es aquella que más requiere de recambios cuando ingresa a un taller, se puede notar en el gráfico que, la falla usual más temprana que registra es por concepto del cargador portable, donde estos se cambian en alrededor de los 5.000 kilómetros. En empresas como el ÉXITO o NUTRESA los cargadores portables suelen durar un poco más (alrededor de 10.000 kilómetros). Nuevamente esto indica que si un cargador portable va a fallar en alguna de estas empresas, lo usual es que lo haga cerca de los 5.000 kilómetros en ARGOS y cerca de los 10.000 kilómetros en el ÉXITO o NUTRESA.

- Algo similar sucede en BIMBO, donde el recambio más temprano que es usualmente solicitado es el VCU software, donde la mayor cantidad de cambios en este componente se han realizado por debajo de los 5.000 kilómetros. Esto en contraste con empresas como ARGOS, puesto que en esta última, los cambios de esta unidad se han requerido por encima de los 35.000 kilómetros. Esta información en relación a BIMBO también difiere estadísticamente de las empresas ÉXITO y OPERLOG, puesto que ambas solicitan este repuesto después de los 5.000 kilómetros y en promedio cerca de los 10.000.

- En lo que respecta a las baterías 12v, se puede apreciar una diferencia significativa entre ARGOS y BIMBO, donde en esta última suelen fallar primero que en ARGOS (Antes de los 20.000 kilómetros usualmente).

- Finalmente, respecto a la terminal inteligente del vehículo, se puede ver que en ARGOS, este componente requiere ser cambiado en promedio a los 24.000 kilómetros, sin embargo en este punto la información varía mucho. En contraparte, la empresa BIMBO solicita este repuesto en alrededor de los 5.000 kilómetros, existiendo entre estas dos empresas una diferencia significativa de cara al reemplazo de este componente.

```{r results=F}
library(survival)
library(gamlss)
distkm <- fitDist(data$KILOMETRAJE, type = "realplus")
distkm$mu.coefficients
#rgamma(10000, 1, scale = 15156.8)
```

Finalmente, para un análisis estadístico más técnico es de mucho interés conocer el comportamiento en la curva de distribución de la respuesta (en este caso kilometraje). Así entonces, haciendo uso de diversos test de bondad de ajuste y con la ayuda de diferentes algoritmos se logra concretar que la distribución que mejor se ajusta al kilometraje que registran los camiones al entrar a un taller es la curva de una distribución exponencial. A continuación se ilustra la curva real de la densidad de la respuesta versus la curva que mejor se le ajusta $KILOMETRAJE \sim EXP(15156.8)$
```{r out.height=500, out.width=900}
densityframe <- data.frame(Kilometraje = c(data$KILOMETRAJE,rEXP(10000,15156.8)),
                           Tipo = c(rep("Real",length(data$KILOMETRAJE)),
                                     rep("Ajustado",10000)))

ggplot(densityframe, aes(x=Kilometraje, color=Tipo)) +
  geom_density(lwd=1) +
  xlim(-3000,100000) + 
  labs(y="Densidad", title = "Modelo distribucional para el Kilometraje")

```

En este punto se puede decir que existe un buen ajuste de la distribución en cuestión. Este aspecto resulta fundamental para etapas de modelación posteriores. 